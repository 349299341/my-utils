var port=80,http=require("http"),url=require("url"),fs=require("fs"),path=require("path"),mime=require("./mime").types,config=require("./config"),zlib=require("zlib"),server=http.createServer(function(e,t){var r=url.parse(e.url);t.setHeader("Server","Node/V8"),console.log(r);var i=r.pathname;"/"===i.slice(-1)&&(i+=config.Welcome.file);var a=path.join("assets",path.normalize(i.replace(/\.\./g,"")));console.log(a);var n=function(r){fs.stat(r,function(i,a){if(i)t.writeHead(404,"not found",{"Content-Type":"text/plain"}),t.write("the request "+r+" is not found"),t.end();else if(a.isDirectory());else{var n=path.extname(r);n=n?n.slice(1):"unknown";var o=mime[n]||"text/plain";t.setHeader("Content-Type",o);var s=a.mtime.toUTCString(),p="If-Modified-Since".toLowerCase();if(t.setHeader("Last-Modified",s),n.match(config.Expires.fileMatch)){var c=new Date;c.setTime(c.getTime()+1e3*config.Expires.maxAge),t.setHeader("Expires",c.toUTCString()),t.setHeader("Cache-Control","max-age="+config.Expires.maxAge)}if(e.headers[p]&&s==e.headers[p])console.log("从浏览器cache里取"),t.writeHead(304,"Not Modified"),t.end();else{var l=fs.createReadStream(r),d=e.headers["accept-encoding"]||"",f=n.match(config.Compress.match);f&&d.match(/\bgzip\b/)?(t.writeHead(200,"Ok",{"Content-Encoding":"gzip"}),l.pipe(zlib.createGzip()).pipe(t)):f&&d.match(/\bdeflate\b/)?(t.writeHead(200,"Ok",{"Content-Encoding":"deflate"}),l.pipe(zlib.createDeflate()).pipe(t)):(t.writeHead(200,"Ok"),l.pipe(t))}}})};n(a)});server.listen(port),console.log("http server run in port:"+port);